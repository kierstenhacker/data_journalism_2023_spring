---
title: "lab_10"
author: "Kiersten Hacker"
date: "2023-04-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## You will need

* Our usual libraries, plus some of the map-specific ones from the pre_lab. You'll also be fetching Census data in Q3. Read the questions carefully!

## Load libraries and establish settings

**Task** Create a codeblock and load appropriate packages and settings for this lab.

```{r}
# Load libraries
library(tidyverse)
library(sf)
library(janitor)
library(tigris)
library(tidycensus)
```

Let's explore Maryland elections, power outages and electric vehicle data and make some maps! 

## Questions 

**Q1.** Maryland voters made history in November by electing the state's first two African-American statewide office holders: Wes Moore as governor and Anthony Brown as attorney general. You want to compare the two's electoral performances. Using the `md_statewide_county.csv` file in the data folder, calculate the total number of votes for both the governor's race and the attorney general's race, then percentages for both Moore and Brown _based on the total of their respective contests_. Then calculate the difference between their percentages.

Get the geometry for Maryland's counties using tigris and, joining that dataframe to your results dataframe, make a county-level map of the differences between Moore and Brown's percentages. What is the story here, and what is the county with the most interesting results?

**A1. I think the story here centers around Kent, Queen Anne's and Carroll counties who had the largest difference in votes between Moore and Brown. Why is the difference so large? It is also interesting that in Baltimore City and Prince George's County, Brown received a higher percentage of votes compared to Moore. Why is that? If I were reporting a story I would want to know where the discrepancies are coming from. What makes the people vote for one candidate more than the other even though they are for different offices?  ** 

```{r}
md_statewide_county <- read_csv("data/md_statewide_county.csv")

md_statewide_county_totals <- md_statewide_county %>%
  mutate (total_gov = Cox + Moore + Lashar + Wallace + Harding + Sefcik + GovWritein, 
          total_ag = Peroutka + Brown + AgWritein,
          pct_moore = Moore/total_gov *100,
          pct_brown = Brown/total_ag *100,
          pct_difference = pct_moore - pct_brown)

counties <- counties()
md_counties <- counties %>%
  filter(STATEFP == "24")
md_counties %>%
  ggplot() +
  geom_sf() +
  theme_minimal()

md_statewide_county_totals <- md_statewide_county_totals %>%
  mutate(across(GEOID, as.character))

counties_with_votes <- md_counties %>% left_join(md_statewide_county_totals, by=c("GEOID"="GEOID"))

ggplot() +
  geom_sf(data=counties_with_votes, aes(fill=pct_difference)) +
  theme_minimal()
```


**Q2.** Make a county-level map to explore the number of customers impacted by power outages in Maryland. Load the `county_outages_march2023.csv` file in the data folder and calculate a rate of customers with outages per 10,000 total customers for each county. Then join that dataframe to your Maryland counties dataframe you made in Q1 and create a county-level map of the results; you may need to tweak the fill scale to make the distinctions clearer. What's the potential story here? Given access to other months' outage data, what would your next steps be in reporting a story?

**A2. I think the story here is that Talbot County had a significantly higher rate of outages in March 2023 compared to the rest of the Maryland counties. If I had access to the data from other months I would compare to see what could be the cause of these outages. Perhaps other months had higher outages or perhaps Talbot only had the highest rate during March. Comparing the different months could give us a hint if there are any trends in which months have more outages leading us to make predictions about the cause of the outages. Maybe weather in March caused a higher rate on the eastern shore or maybe warmer summer months would have more outages due to the possibility of black outs. I think these factors could lead to possible stories focusing on Talbot County.** 

```{r}
county_outages_march2023 <- read_csv("data/county_outages_march2023.csv")

county_outages_march2023_rate <- county_outages_march2023 %>%
  mutate (rate = outage_customers/total_customers *10000)

counties_outage_rates <- md_counties %>% left_join(county_outages_march2023_rate, by=c("NAME"="county"))

ggplot() +
  geom_sf(data=counties_outage_rates, aes(fill=rate)) +
  theme_minimal() +
  scale_fill_viridis_b(option="magma", trans = "log")
```

**Q3.** You've been assigned a story about the use of electric vehicles in Maryland and you want to make a map of the prevalence of electric vehicles in each county. Load the `ev_2020_2023.csv` file, which has the number of electric and hybrid vehicles per county from July 2020 and March 2023 and calculate a percentage change for each county (remember, that's `new-old/old`). Using the Maryland counties dataframe you made for Q1, make a county map showing the percentage change. What counties stand out to you? What questions do you have about the changes you're seeing?

Next, use tidycensus to retrieve county population data for Maryland from 2021 (you did this in the pre_lab) and join it to your vehicles dataframe. HINT: you may not need to join it on the county name, and you should already have the geometry!

Then, calculate a per capita rate of electric & hybrid vehicles using the March 2023 figure and the population estimate. You will need to choose the "per capita" value.

Finally, make a second county map showing the per capita rate. What counties stand out on this map? How is it different from the first one you made?

**A3. Caroline County sticks out to me with the highest percent change. Given the geography and demographics of Maryland counties I would not think that Caroline would be likely to have such a high rate of change. I wonder if there was actually a high increase in the electric and hybrid vehicles or if it was only a small change but the percent change was high. Based on the per capita rate Montgomery County and Howard County have the highest rate of electric and hybrid vehicles which makes sense given the population and income in those two counties. It shows that even though some rural counties, including Talbot County, had higher percent changes in electric and hybrid vehicles, they actually have a lower rate of these vehivles per capita compared to richer, more populated counties.  ** 

```{r}
ev_2020_2023 <- read_csv("data/ev_2020_2023.csv")

ev_2020_2023_rates <- ev_2020_2023 %>%
  mutate (pct_change = (march_2023-july_2020)/july_2020*100)

counties_ev_2020_2023_rates <- md_counties %>% left_join(ev_2020_2023_rates, by=c("NAME"="county"))

ggplot() +
  geom_sf(data=counties_ev_2020_2023_rates, aes(fill=pct_change)) +
  theme_minimal() + 
  scale_fill_viridis_b(option="magma", trans = "log")
```
```{r}
md_county_population <- get_acs(geography = "county",
              variables = c(population = "B01001_001"),
              year = 2021,
              state = "MD")

md_pop_with_ev <- counties_ev_2020_2023_rates %>% left_join(md_county_population, by=c("GEOID"="GEOID"))

md_pop_with_ev_rates <- md_pop_with_ev %>%
  mutate(ev_per_capita = march_2023/estimate *10000)

ggplot() +
  geom_sf(data=md_pop_with_ev_rates, aes(fill=ev_per_capita)) +
  theme_minimal() + 
  scale_fill_viridis_b(option="magma", trans = "log")
```

